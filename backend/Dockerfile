FROM python:3.12.2-alpine3.19

ARG SECRET_KEY 
ARG DATABASE_URI
ARG OPENAI_API_KEY
ARG ASSISTANT_INSTRUCTIONS
ARG SMTP_SERVER
ARG SENDER_EMAIL
ARG PASSWORD
ARG ENV

ENV SECRET_KEY=$SECRET_KEY
ENV DATABASE_URI=$DATABASE_URI
ENV OPENAI_API_KEY=$OPENAI_API_KEY
ENV ASSISTANT_INSTRUCTIONS=$ASSISTANT_INSTRUCTIONS
ENV SMTP_SERVER=$SMTP_SERVER
ENV SENDER_EMAIL=$SENDER_EMAIL
ENV PASSWORD=$PASSWORD
ENV ENV=$ENV

FROM python:3.12.2-alpine3.19 AS build

ARG SECRET_KEY 
ARG DATABASE_URI
ARG OPENAI_API_KEY
ARG ASSISTANT_INSTRUCTIONS
ARG SMTP_SERVER
ARG SENDER_EMAIL
ARG PASSWORD
ARG ENV

ENV SECRET_KEY=$SECRET_KEY
ENV DATABASE_URI=$DATABASE_URI
ENV ASSISTANT_INSTRUCTIONS=$ASSISTANT_INSTRUCTIONS
ENV SMTP_SERVER=$SMTP_SERVER
ENV SENDER_EMAIL=$SENDER_EMAIL
ENV PASSWORD=$PASSWORD
ENV ENV=$ENV

WORKDIR /app

COPY . /app/

RUN apk update &&\
  apk add pkgconfig ffmpeg musl-dev mariadb-connector-c-dev gcc &&\
  pip install --upgrade pip &&\
  pip install -r requirements.txt

EXPOSE 8080

CMD ["python", "prod.py"]